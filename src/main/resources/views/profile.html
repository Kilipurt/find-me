<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Find me</title>
</head>
<body>
<div class="menu">
    <a href="#" id="my-profile-btn">My profile</a>
    <br>

    <a href="#" onclick="newsLoad()">News</a>
    <br>

    <a href="#" onclick="getChats()">Chats</a>
    <br>

    <hr>
    <a href="#" id="logout">Logout</a>
</div>

<div class="user-info">
    <div class="left">
        <div class="photo">Photo</div>

        <div class="relationship-status" id="relationship-status">
            <p id="status-field" th:text="${relationship != null} ? ${relationship.status} : 'Not friend'"></p>
        </div>

        <p>
            <button id="sentFriendRequest" type="submit">Add to friends</button>
        </p>

        <p>
            <button id="sentMessageFormDisplay" onclick="displaySentMessageForm()">Sent message</button>
        </p>

        <form id="sent-message-form">
            <p>Text:</p>
            <input id="text" type="text" name="text"/>
            <button type="submit">Send Message</button>
        </form>
        <button id="sentMessageFormHide" onclick="hideSentMessageForm()">Cancel</button>
    </div>

    <div class="right">
        <p class="userId" id="userId" th:text="${user.id}"></p>
        <p class="userFirstName" id="userFirstName" th:text="${user.firstName}"></p>
        <p class="userLastName" id="userLastName" th:text="${user.lastName}"></p>
        <p class="userPhone" id="userPhone" th:text="${user.phone}"></p>
        <p class="userCountry" id="userCountry" th:text="${user.country}"></p>
        <p class="userCity" id="userCity" th:text="${user.city}"></p>
        <p class="userAge" id="userAge" th:text="${user.age}"></p>
        <p class="userDateRegistered" id="userDateRegistered" th:text="${user.dateRegistered}"></p>
        <p class="userDateLastActive" id="userDateLastActive" th:text="${user.dateLastActive}"></p>
        <p class="userRelationshipStatus" id="userRelationshipStatus" th:text="${user.relationshipStatus}"></p>
        <p class="userReligion" id="userReligion" th:text="${user.religion}"></p>
        <p class="userSchool" id="userSchool" th:text="${user.school}"></p>
        <p class="userUniversity" id="userUniversity" th:text="${user.university}"></p>

        <hr>

        <div class="requests">
            <div class="incomeRequests" id="incomeRequests">
                <h4>Income Requests</h4>
            </div>

            <div class="outcomeRequests" id="outcomeRequests">
                <h4>Outcome Requests</h4>
            </div>
        </div>
    </div>

    <hr>

    <div class="posts">
        <div class="create-post-div">
            <button id="post-form-display" onclick="displayPostForm()">New post</button>

            <form id="post-form">
                <p>Text</p>
                <input id="postMessage" name="postMessage" type="text"/>

                <form id="tagged-users-form">
                    <p>Tagged users</p>

                    <input id="tagged-users-input" list="taggedUsers" name="taggedUsers"
                           oninput="getFriendsByPattern()">
                    <datalist id="taggedUsers">
                        <th:block th:each="friend : ${friends}">
                            <option th:value="${friend.firstName} ${friend.lastName}"></option>
                        </th:block>
                    </datalist>

                    <button type="submit">Tag</button>
                </form>

                <p>Location</p>
                <input id="location" name="location" type="text"/>

                <button type="submit">Create</button>
            </form>

            <button id="post-form-hide" onclick="hidePostForm()">Cancel</button>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</body>

<style>
    body {
        background-color: honeydew;
    }

    a {
        font-weight: 700;
        text-decoration: none;
        border-radius: 3px;
        background: inherit;
        transition: 0.2s;
        margin: 5px;
    }

    a:hover {
        background: honeydew;
    }

    .menu {
        background-color: lightblue;
        border: 2px solid cornflowerblue;
        border-radius: 30px;
        float: left;
        padding: 20px;
        margin: 40px 20px 20px 20px;
        position: absolute;
        left: 100px;
        height: auto;
    }

    .menu ul {
        list-style: none;
    }

    .menu ul li button {
        display: block;
        margin-top: 3px;
        padding-left: 5px;
        padding-top: 4px;
        padding-bottom: 4px;
    }

    .photo {
        text-align: center;
        width: 200px;
        height: 300px;
        border-style: solid;
    }

    .user-info {
        border: 2px solid cornflowerblue;
        border-radius: 30px;
        position: absolute;
        left: 250px;
        margin: 20px;
    }

    .right {
        margin: 20px;
        padding: 20px;
    }

    .left {
        background-color: lightblue;
        border: 2px solid cornflowerblue;
        border-radius: 30px;
        float: left;
        padding: 20px;
        margin: 20px 50px 20px 20px;
    }

    .right {
        background-color: lightblue;
        border: 2px solid cornflowerblue;
        border-radius: 30px;
        overflow: auto;
        margin: 20px;
    }

    .userId, .loginUserId {
        display: none;
    }
</style>

<script th:inline="javascript">
    var loggedInUser = JSON.parse(localStorage.getItem('user'));

    $(document).ready(function () {
        if (loggedInUser == null) {
            loggedInUser = [[${user}]];
            localStorage.setItem('user', JSON.stringify(loggedInUser));
        }
    });

    $(document).ready(function getRelationshipStatus() {
        $.ajax({
            url: "/get-relationship",
            type: "GET",
            data: {
                loggedInUserId: loggedInUser.id,
                userId: $('#userId').text()
            }
        });

        return false;
    });

    $(document).ready(function (e) {
        hidePostForm();
        hideSentMessageForm();

        if ($('#userId').text() == loggedInUser.id) {
            document.getElementById("sentFriendRequest").style.display = 'none';
            document.getElementById('sentMessageFormHide').style.display = 'none';
            document.getElementById("relationship-status").style.display = 'none';
            document.getElementById('sentMessageFormDisplay').style.display = 'none';
        } else {
            document.getElementById("incomeRequests").style.display = 'none';
            document.getElementById("outcomeRequests").style.display = 'none';
        }

        if ($('#status-field').text() == 'FRIENDS') {
            document.getElementById('sentFriendRequest').style.display = 'none';
        }
    });

    function displayPostForm() {
        document.getElementById('post-form').style.display = 'block';
        document.getElementById('post-form-hide').style.display = 'block';
        document.getElementById('post-form-display').style.display = 'none';
    }

    function hidePostForm() {
        document.getElementById('post-form').style.display = 'none';
        document.getElementById('post-form-hide').style.display = 'none';
        document.getElementById('post-form-display').style.display = 'block';
    }

    function displaySentMessageForm() {
        document.getElementById('sentMessageFormDisplay').style.display = 'none';
        document.getElementById('sent-message-form').style.display = 'block';
        document.getElementById('sentMessageFormHide').style.display = 'block';
    }

    function hideSentMessageForm() {
        document.getElementById('sent-message-form').style.display = 'none';
        document.getElementById('sentMessageFormHide').style.display = 'none';
        document.getElementById('sentMessageFormDisplay').style.display = 'block';
    }

    function getChats() {
        window.location.replace("/chats/" + loggedInUser.id);
    }

    function newsLoad() {
        window.location.replace("/feed/" + loggedInUser.id);
    }

    $('#my-profile-btn').click(function getProfile() {
        window.location.replace('/user/' + loggedInUser.id);
    });

    $('#sent-message-form').submit(function (e) {
        var userTo = [[${user}]];
        //var userFrom = [[${loginUser}]];

        var message = {
            text: document.getElementById('text').value,
            userTo: userTo,
            userFrom: loggedInUser//userFrom
        };

        $.ajax({
            url: "/send-message",
            type: "POST",
            data: JSON.stringify(message),
            dataType: "json",
            contentType: "application/json",
            success: function success(xhr) {
                hideSentMessageForm();
                alert("Message sent successfully");
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    });

    $(document).ready(function (e) {
        if ($('#userId').text() == loggedInUser.id) {
            $.ajax({
                url: "/income-requests/" + loggedInUser.id,
                type: "GET",
                success: function success(xhr) {
                    var incomeRequestsDiv = document.getElementById("incomeRequests");

                    var users = JSON.parse(xhr.toString());

                    for (var i = 0; i < users.users.length; i++) {
                        var aloneRequestDiv = document.createElement("div");

                        aloneRequestDiv.innerHTML = users.users[i].id + " "
                            + users.users[i].firstName + " "
                            + users.users[i].lastName + " ";

                        var denyButton = document.createElement("button");
                        denyButton.innerHTML = "Deny request";
                        denyButton.id = "denyButton" + users.users[i].id;
                        denyButton.addEventListener("click", denyRequest);

                        aloneRequestDiv.insertAdjacentElement("beforeEnd", denyButton);

                        var acceptButton = document.createElement("button");
                        acceptButton.innerHTML = "Accept request";
                        acceptButton.id = "acceptButton" + users.users[i].id;
                        acceptButton.addEventListener("click", acceptRequest);

                        aloneRequestDiv.insertAdjacentElement("beforeEnd", acceptButton);
                        incomeRequestsDiv.insertAdjacentElement("beforeEnd", aloneRequestDiv);
                    }
                },
                error: function error(xhr) {
                    alert(xhr.responseText);
                }
            });
        }
        return false;
    });

    $(document).ready(function (e) {
        if ($('#userId').text() == loggedInUser.id) {
            $.ajax({
                url: "/outcome-requests/" + loggedInUser.id,
                type: "GET",
                success: function success(xhr) {
                    var outcomeRequestsDiv = document.getElementById("outcomeRequests");
                    var users = JSON.parse(xhr.toString());

                    for (var i = 0; i < users.users.length; i++) {
                        var aloneRequestDiv = document.createElement("div");

                        aloneRequestDiv.innerHTML = users.users[i].id + " "
                            + users.users[i].firstName + " "
                            + users.users[i].lastName + " ";

                        var cancelButton = document.createElement("button");
                        cancelButton.innerHTML = "Cancel request";
                        cancelButton.id = "cancelButton" + users.users[i].id;
                        cancelButton.addEventListener("click", cancelRequest);

                        aloneRequestDiv.insertAdjacentElement("beforeEnd", cancelButton);
                        outcomeRequestsDiv.insertAdjacentElement("beforeEnd", aloneRequestDiv);
                    }
                },
                error: function error(xhr) {
                    alert(xhr.responseText);
                }
            });
        }
        return false;
    });

    $('#logout').on("click", function (e) {
        $.ajax({
            url: "/logout",
            type: "GET",
            success: function success(xhr) {
                loggedInUser = null;
                window.location.replace("/");
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    });

    $('#sentFriendRequest').on("click", function (e) {
        if ($('#status-field').text() == 'Not friends') {
            $.ajax({
                url: "/add-relationship",
                type: "POST",
                data: {
                    userIdFrom: loggedInUser.id,
                    userIdTo: $('#userId').text()
                },
                success: function success(xhr) {
                    alert("Request sent successfully");
                },
                error: function error(xhr) {
                    alert(xhr.responseText);
                }
            });
            return false;
        } else {
            var url = "/update-relationship?userIdTo=" + $('#userId').text() + "&userIdFrom="
                + loggedInUser.id + "&status=REQUEST_SENT";

            updateRelationship(url)
        }
    });

    function cancelRequest() {
        $.ajax({
            url: "/update-relationship?userIdFrom=" + loggedInUser.id + "&userIdTo="
            + this.id.replace('cancelButton', '') + "&status=DELETED",
            type: 'PUT',
            success: function success(xhr) {
                alert("success");
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    }

    function denyRequest() {
        $.ajax({
            url: "/update-relationship?userIdTo=" + loggedInUser.id + "&userIdFrom="
            + this.id.replace('denyButton', '') + "&status=REQUEST_DECLINED",
            type: 'PUT',
            success: function success(xhr) {
                alert("success");
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    }

    function acceptRequest() {
        var url = "/update-relationship?userIdTo=" + loggedInUser.id + "&userIdFrom="
            + this.id.replace('acceptButton', '') + "&status=FRIENDS";

        updateRelationship(url);
    }

    function updateRelationship(url) {
        $.ajax({
            url: url,
            type: 'PUT',
            success: function success(xhr) {
                alert("success");
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    }

    $("#post-form").submit(function (e) {
        $.ajax({
            url: "/add-post",
            type: "POST",
            data: {
                message: document.getElementById("postMessage").value,
                usersTagged: document.getElementById("taggedUsers").value,
                userPosted: loggedInUser.id,
                userPagePosted: $('#userId').text(),
                location: document.getElementById("location").value
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    });
</script>
</html>