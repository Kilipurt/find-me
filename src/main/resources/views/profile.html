<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Find me</title>
</head>
<body>

<!--<div th:replace="fragments/header :: header"/>-->

<div>
    <div class="left">
        <h1>Photo</h1>
    </div>

    <div class="right">
        <p class="userId" id="userId" th:text="${user.id}"></p>
        <p class="userFirstName" id="userFirstName" th:text="${user.firstName}"></p>
        <p class="userLastName" id="userLastName" th:text="${user.lastName}"></p>
        <p class="userPhone" id="userPhone" th:text="${user.phone}"></p>
        <p class="userCountry" id="userCountry" th:text="${user.country}"></p>
        <p class="userCity" id="userCity" th:text="${user.city}"></p>
        <p class="userAge" id="userAge" th:text="${user.age}"></p>
        <p class="userDateRegistered" id="userDateRegistered" th:text="${user.dateRegistered}"></p>
        <p class="userDateLastActive" id="userDateLastActive" th:text="${user.dateLastActive}"></p>
        <p class="userRelationshipStatus" id="userRelationshipStatus" th:text="${user.relationshipStatus}"></p>
        <p class="userReligion" id="userReligion" th:text="${user.religion}"></p>
        <p class="userSchool" id="userSchool" th:text="${user.school}"></p>
        <p class="userUniversity" id="userUniversity" th:text="${user.university}"></p>

        <p class="loginUserId" id="loginUserId" th:text="${loginUser.id}" hidden></p>
    </div>

    <!--<div class="post-div">-->
    <!--<form id="post-form">-->
    <!--<p>Message</p>-->
    <!--<input id="postMessage" name="postMessage" type="text"/>-->

    <!--<p>Tagged users</p>-->
    <!--<input id="taggedUsers" name="taggedUsers" type="text"/>-->

    <!--<p>Location</p>-->
    <!--<input id="location" name="location" type="text"/>-->

    <!--<button type="submit">Create</button>-->
    <!--</form>-->
    <!--</div>-->

    <button id="news-button" type="submit" onclick="newsLoad()">News</button>

    <div class="relationship-status" id="relationship-status">
        <p id="status-field" th:text="${relationshipStatus}"></p>
    </div>

    <div class="incomeRequests" id="incomeRequests">
        <h4>Income Requests</h4>
    </div>

    <div class="outcomeRequests" id="outcomeRequests">
        <h4>Outcome Requests</h4>
    </div>

    <p>
        <button id="sentFriendRequest" type="submit">Add to friends</button>
    </p>

    <p>
        <button id="sentMessageFormDisplay" onclick="displaySentMessageForm()">Sent message</button>
    </p>

    <form id="sent-message-form">
        <p>Text:</p>
        <input id="text" type="text" name="text"/>
        <button type="submit">Send Message</button>
    </form>
    <button id="sentMessageFormHide" onclick="hideSentMessageForm()">Cancel</button>

    <p class="logout">
        <button id="logout" type="submit">Logout</button>
    </p>
</div>
<!--/.container-->
<!---->
<!--<div th:replace="fragments/footer :: footer"/>-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</body>

<style>
    .left {
        float: left;
        width: 200px;
        height: 300px;
        border-style: solid;
    }

    .right {
        margin-left: 300px;
    }

    .btn {
        margin-top: 230px;
    }

    .logout {
        float: left;
    }

    .userId {
        display: none;
    }

    .loginUserId {
        display: none;
    }
</style>

<script th:inline="javascript">
    function displaySentMessageForm() {
        document.getElementById('sentMessageFormDisplay').style.display = 'none';
        document.getElementById('sent-message-form').style.display = 'block';
        document.getElementById('sentMessageFormHide').style.display = 'block';
    }

    function hideSentMessageForm() {
        document.getElementById('sent-message-form').style.display = 'none';
        document.getElementById('sentMessageFormHide').style.display = 'none';
        document.getElementById('sentMessageFormDisplay').style.display = 'block';
    }

    $('#sent-message-form').submit(function (e) {
        var userTo = [[${user}]];
        var userFrom = [[${loginUser}]];

        var message = {
            text: document.getElementById('text').value,
            userTo: userTo,
            userFrom: userFrom
        };

        $.ajax({
            url: "/send-message",
            type: "POST",
            data: JSON.stringify(message),
            dataType: "json",
            contentType: "application/json",
            success: function success(xhr) {
                hideSentMessageForm();
                alert("Message sent successfully");
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    });

    $(document).ready(function () {
        document.getElementById('sent-message-form').style.display = 'none';
        document.getElementById('sentMessageFormHide').style.display = 'none';

        if ($('#userId').text() == $('#loginUserId').text()) {
            document.getElementById("sentFriendRequest").style.display = 'none';
            document.getElementById('sentMessageFormHide').style.display = 'none';
            document.getElementById("relationship-status").style.display = 'none';
            document.getElementById('sentMessageFormDisplay').style.display = 'none';
        } else {
            document.getElementById("incomeRequests").style.display = 'none';
            document.getElementById("outcomeRequests").style.display = 'none';
        }
    });

    $(document).ready(function (e) {
        if ($('#userId').text() == $('#loginUserId').text()) {
            $.ajax({
                url: "/income-requests/" + $('#loginUserId').text(),
                type: "GET",
                success: function success(xhr) {
                    var incomeRequestsDiv = document.getElementById("incomeRequests");

                    var users = JSON.parse(xhr.toString());

                    for (var i = 0; i < users.users.length; i++) {
                        var aloneRequestDiv = document.createElement("div");

                        aloneRequestDiv.innerHTML = users.users[i].id + " "
                            + users.users[i].firstName + " "
                            + users.users[i].lastName + " ";

                        var denyButton = document.createElement("button");
                        denyButton.innerHTML = "Deny request";
                        denyButton.id = "denyButton" + users.users[i].id;
                        denyButton.addEventListener("click", denyRequest);

                        aloneRequestDiv.insertAdjacentElement("beforeEnd", denyButton);

                        var acceptButton = document.createElement("button");
                        acceptButton.innerHTML = "Accept request";
                        acceptButton.id = "acceptButton" + users.users[i].id;
                        acceptButton.addEventListener("click", acceptRequest);

                        aloneRequestDiv.insertAdjacentElement("beforeEnd", acceptButton);
                        incomeRequestsDiv.insertAdjacentElement("beforeEnd", aloneRequestDiv);
                    }
                },
                error: function error(xhr) {
                    alert(xhr.responseText);
                }
            });
        }
        return false;
    });

    $(document).ready(function (e) {
        if ($('#userId').text() == $('#loginUserId').text()) {
            $.ajax({
                url: "/outcome-requests/" + $('#loginUserId').text(),
                type: "GET",
                success: function success(xhr) {
                    var outcomeRequestsDiv = document.getElementById("outcomeRequests");
                    var users = JSON.parse(xhr.toString());

                    for (var i = 0; i < users.users.length; i++) {
                        var aloneRequestDiv = document.createElement("div");

                        aloneRequestDiv.innerHTML = users.users[i].id + " "
                            + users.users[i].firstName + " "
                            + users.users[i].lastName + " ";

                        var cancelButton = document.createElement("button");
                        cancelButton.innerHTML = "Cancel request";
                        cancelButton.id = "cancelButton" + users.users[i].id;
                        cancelButton.addEventListener("click", cancelRequest);

                        aloneRequestDiv.insertAdjacentElement("beforeEnd", cancelButton);
                        outcomeRequestsDiv.insertAdjacentElement("beforeEnd", aloneRequestDiv);
                    }
                },
                error: function error(xhr) {
                    alert(xhr.responseText);
                }
            });
        }
        return false;
    });

    $('#logout').on("click", function (e) {
        $.ajax({
            url: "/logout",
            type: "GET",
            success: function success(xhr) {
                window.location.replace("/");
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    });

    $('#sentFriendRequest').on("click", function (e) {
        if ($('#status-field').text() == 'Not friends') {
            $.ajax({
                url: "/add-relationship",
                type: "POST",
                data: {
                    userIdFrom: $('#loginUserId').text(),
                    userIdTo: $('#userId').text()
                },
                success: function success(xhr) {
                    alert("Request sent successfully");
                },
                error: function error(xhr) {
                    alert(xhr.responseText);
                }
            });
            return false;
        } else {
            var url = "/update-relationship?userIdTo=" + $('#userId').text() + "&userIdFrom="
                + $('#loginUserId').text() + "&status=REQUEST_SENT";

            updateRelationship(url)
        }
    });

    function cancelRequest() {
        $.ajax({
            url: "/update-relationship?userIdFrom=" + $('#loginUserId').text() + "&userIdTo="
            + this.id.replace('cancelButton', '') + "&status=DELETED",
            type: 'PUT',
            success: function success(xhr) {
                alert("success");
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    }

    function denyRequest() {
        $.ajax({
            url: "/update-relationship?userIdTo=" + $('#loginUserId').text() + "&userIdFrom="
            + this.id.replace('denyButton', '') + "&status=REQUEST_DECLINED",
            type: 'PUT',
            success: function success(xhr) {
                alert("success");
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    }

    function acceptRequest() {
        var url = "/update-relationship?userIdTo=" + $('#loginUserId').text() + "&userIdFrom="
            + this.id.replace('acceptButton', '') + "&status=FRIENDS";

        updateRelationship(url);
    }

    function updateRelationship(url) {
        $.ajax({
            url: url,
            type: 'PUT',
            success: function success(xhr) {
                alert("success");
            },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    }

    $("#post-form").submit(function (e) {
        $.ajax({
            url: "/add-post",
            type: "POST",
            data: {
                message: document.getElementById("postMessage").value,
                usersTagged: document.getElementById("taggedUsers").value,
                userPosted: $('#loginUserId').text(),
                userPagePosted: $('#userId').text(),
                location: document.getElementById("location").value
            },
            // success: function success(xhr) {
            //     alert(xhr);
            // },
            error: function error(xhr) {
                alert(xhr.responseText);
            }
        });
        return false;
    });

    function newsLoad() {
        window.location.replace("/feed/" + $('#loginUserId').text());
    }
</script>
</html>